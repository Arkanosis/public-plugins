<html>
  <head>
    <meta name="navigation" content="Website" />
    <title>Private documentation</title>
  </head>
<body> 
  <h2>User records</h2>
  <h3>Users in Ensembl</h3>
  From Release 42 (Dec 2006), users of Ensembl can create new accounts and login to customise their usage of the browser. Ensembl includes a standard way of easily storing and retrieving a user's data, with the <code>EnsEMBL::Web::User::Record</code> module. 
  <h3>Persistent user data</h3>
  Allowing users to customise views, bookmark pages, record blast tickets and the like, requires a method of making user data persitent. In Ensembl, the <code>EnsEMBL::Web::User::Record</code> class is responsible for saving, loading and modifying data saved by the user. The module can handle multiple types of data, and can store all Perl data types (strings, arrays and hashes) along with blessed objects.
  <ul>
  <h4>Active record</h4>
  The <code>Record</code> class is based on the Active Record pattern. Each <code>Record</code> object wraps a row in a database table or view, encapsulates the database access, and adds domain logic on that data <a name="anchor_1"></a><a href="#footnote_1"><sup>1</sup></a>.  
  <h4>Saving user data</h4>
  Saving new user data is relatively straightforward, and is all performed with a new <code>Record</code> object. For example, to add a new bookmark:
  <code><pre>
  sub add_bookmark {
    my ($self, %params) = @_;
    my $user_id = $ENV{ENSEMBL_USER_ID};
    my $record = EnsEMBL::Web::User::Record->new(( adaptor => $params{adaptor} )); 
    $record->user($params{user_id});
    $record->type('bookmarks');
    $record->name($params{name});
    $record->url($params{url});
    $record->save;
  }
  </pre></code>
  Upon the <code>save</code> method, the record is committed to the database.
  <h4>Updating user data</h4>
  Once a record has been committed to, or retrieved from a database, the <code>save</code> method call will update the existing record. Renaming our bookmark, for example, is straightforward:
  <code><pre>
  sub update_bookmark {
    my ($self, $record, $new_name) = @_;
    $record->name($new_name);
    $record->save;
  }
  </pre></code>
  <a name="find_by"></a><h4>Retrieving user data</h4>
  Retrieving previously saved information to the database is also easy. For example, retrieving all bookmarks for a single user requires a single line:
  <code><pre>
    my $records = EnsEMBL::Web::User::Record->find_bookmark_by_user_id('42');
  </code></pre>
  You could also search for records of the 'ticket' type with:
  <code><pre>
    my $records = EnsEMBL::Web::User::Record->find_ticket_by_user_id('42');
  </code></pre>
  </ul>
  <h3>User::Record is automagical</h3>
  <code>User::Record</code> only has three predetermined parameters, all of which should be set before save is called:
  <ul>
    <li>adaptor: the adaptor to use for database access</li>
    <li>user: the id of the user</li>
    <li>type: the type of the record</li>
  </ul>
  Other than these three parameters, <code>User::Record</code> can be used to access any other parameter automatically just by calling a method of the same name on the object. All parameters will be repopulated when the user data is retrieved from the database (typically with a <a href="#find_by">find_by</a> class method call), and can be accessed again, with a method call. 
  <br /><br />
  In the bookmark example above, the bookmark name and url are being automatically set via the <code>$record->name</code> and <code>$record->url</code> methods. No additional accessor glue code is required.
  <br /><br />
  Likewise, the <code>find_by</code> method automatically retrieves the record objects based upon the available saved parameters and supplied predicate. Whilst in the example above we return bookmarks by user id, we could also access a specific bookmark record via its own unique identifier:
  <code><pre>
  sub get_bookmark {
    my ($self, $id) = @_; 
    return EnsEMBL::Web::User::Record->find_bookmark_by_id($id); 
  }
  </pre></code>
  <h3>Footnotes</h3>
  <ul>
    <li><a name="footnote_1"></a>1. Martin Fowler, Patterns of Enterprise Application Architecture. Addison-Wesley. p160. <a href="http://en.wikipedia.org/wiki/Active_record">Wikipedia entry</a>. <a href="#anchor_1">&uarr;</a></li>
  </ul>
</body>
</html>
  
