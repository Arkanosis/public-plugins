#!/usr/local/bin/perl

=head1 NAME

start_nginx_config - takes nginx.conf.tmpl and creates nginx.conf from it, replacing placeholders

=head1 SYNOPSIS

    require('.../path/to/..start_nginx_config');

=head1 DESCRIPTION

This script takes $SiteDefs::ENSEMBL_NGINX_ROOT/conf/nginx.conf.tmpl and creates nginx.conf from it, replacing placeholders.
It needs SiteDefs configs so it must be either 'required' from ctrl_scripts/start_server or correct SiteDefs must be used in place.

=head1 LICENCE

This code is distributed under an Apache style licence:
Please see http://www.ensembl.org/code_licence.html for details

=head1 AUTHOR

Eugene Bragin <eb4@sanger.ac.uk>

=head1 CONTACT

Post questions to the EnsEMBL webteam list ensembl-webteam@sanger.ac.uk

=cut

use strict;
use warnings;

use SiteDefs;

print "Writing nginx config... \n";

die "can't find nginx root, ENSEMBL_NGINX_ROOT is not defined"
  unless defined $SiteDefs::ENSEMBL_NGINX_ROOT;

die "nginx root '$SiteDefs::ENSEMBL_NGINX_ROOT' does not exists"
  unless -d $SiteDefs::ENSEMBL_NGINX_ROOT;

die "file $SiteDefs::ENSEMBL_NGINX_ROOT/conf/nginx.conf.tmpl does not exists"
  unless -e $SiteDefs::ENSEMBL_NGINX_ROOT . '/conf/nginx.conf.tmpl';


my @nginx_conf_tmpl;

open TMPL, $SiteDefs::ENSEMBL_NGINX_ROOT . '/conf/nginx.conf.tmpl'
  or die "can't open $SiteDefs::ENSEMBL_NGINX_ROOT/conf/nginx.conf.tmpl for reading\n";
@nginx_conf_tmpl = <TMPL>; 

close TMPL;

die "$SiteDefs::ENSEMBL_NGINX_ROOT/conf/nginx.conf.tmpl contents appears to be empty"
  unless @nginx_conf_tmpl;

open CONF, '>', "$SiteDefs::ENSEMBL_NGINX_ROOT/conf/nginx.conf"
  or die "can't open $SiteDefs::ENSEMBL_NGINX_ROOT/conf/nginx.conf for writing\n";

s/\[\[(.*?)\]\]/eval $1;/ge for @nginx_conf_tmpl;

unshift @nginx_conf_tmpl, "# This is an autogenerated file, please use nginx.conf.tmpl or SiteDefs.pm to modify it.\n";
print CONF $_ for @nginx_conf_tmpl;

close CONF;

print "$SiteDefs::ENSEMBL_NGINX_ROOT/conf/nginx.conf has been written\n";

1;