// Generated by CoffeeScript 1.12.6
(function() {
  var Table, TableHolder, TableState, _clone_array;

  _clone_array = function(a) {
    return $.extend(true, [], a);
  };

  TableState = (function() {
    function TableState(el, scols) {
      var c, j, len;
      this._filter = [];
      this._order = [];
      this._colkey = {};
      for (j = 0, len = scols.length; j < len; j++) {
        c = scols[j];
        this._colkey[c.key] = c;
      }
      this._sortkey = {};
      this.el = $(el);
      this.el.data('columns', (function() {
        var l, len1, results;
        results = [];
        for (l = 0, len1 = scols.length; l < len1; l++) {
          c = scols[l];
          results.push(c.key);
        }
        return results;
      })());
      this.el.data('pagesize', 10);
      this.el.on('fix_widths', (function(_this) {
        return function() {
          var col, columns, i, l, len1, len2, len3, m, n, o, perc_per_unit, results, total, units_used;
          columns = _this.el.data('columns');
          for (l = 0, len1 = columns.length; l < len1; l++) {
            c = columns[l];
            if (_this._colkey[c].width === 0) {
              _this._colkey[c].width = 1;
            }
          }
          units_used = 0;
          for (m = 0, len2 = columns.length; m < len2; m++) {
            c = columns[m];
            units_used += _this._colkey[c].width;
          }
          perc_per_unit = 100 / units_used;
          total = 0;
          for (n = 0, len3 = columns.length; n < len3; n++) {
            c = columns[n];
            _this._colkey[c].total = _this._colkey[c].width * perc_per_unit + total;
            total += _this._colkey[c].width * perc_per_unit;
            _this._colkey[c].percent = 0;
          }
          col = 0;
          results = [];
          for (i = o = 0; o <= 99; i = ++o) {
            if (i > _this._colkey[columns[col]].total && col < columns.length) {
              col++;
            }
            results.push(_this._colkey[columns[col]].percent++);
          }
          return results;
        };
      })(this));
    }

    TableState.prototype.e = function() {
      return this.el;
    };

    TableState.prototype._update_sortkey = function() {
      var j, len, r, ref, results;
      this._sortkey = {};
      ref = this._order;
      results = [];
      for (j = 0, len = ref.length; j < len; j++) {
        r = ref[j];
        results.push(this._sortkey[r.column] = r.order);
      }
      return results;
    };

    TableState.prototype.filter = function(f) {
      if (f != null) {
        this._filter = f;
      }
      return this._filter;
    };

    TableState.prototype.columns = function() {
      return this.el.data('columns');
    };

    TableState.prototype.order = function(r) {
      if (r != null) {
        this._order = r;
        this._update_sortkey();
      }
      return this._order;
    };

    TableState.prototype.page = function(p) {
      var ref;
      if (p != null) {
        this.el.data('page', p);
      }
      return (ref = this.el.data('page')) != null ? ref : 1;
    };

    TableState.prototype.pagesize = function() {
      if (this.pagesize_override) {
        return this.pagesize_override;
      } else {
        return this.el.data('pagesize');
      }
    };

    TableState.prototype.start = function() {
      return (this.page() - 1) * this.pagesize();
    };

    TableState.prototype.coldata = function() {
      var j, k, len, ref, results;
      ref = this.el.data('columns');
      results = [];
      for (j = 0, len = ref.length; j < len; j++) {
        k = ref[j];
        results.push(this._colkey[k]);
      }
      return results;
    };

    TableState.prototype.sortkey = function(k) {
      return this._sortkey[k];
    };

    TableState.prototype.associate = function(table1) {
      this.table = table1;
    };

    return TableState;

  })();

  TableHolder = (function() {
    function TableHolder(templates, state1, options) {
      this.templates = templates;
      this.state = state1;
      this.options = options != null ? options : {};
      this.state.associate(this);
      if (this.options.chunk_size == null) {
        this.options.chunk_size = 1000;
      }
    }

    TableHolder.prototype.transmit_data = function(el, fn, data) {
      var $form, c, j, l, len, len1, r, ref, ref1, row, rows;
      rows = [];
      rows.push(data.cols);
      ref = data.rows;
      for (j = 0, len = ref.length; j < len; j++) {
        r = ref[j];
        row = [];
        ref1 = data.cols;
        for (l = 0, len1 = ref1.length; l < len1; l++) {
          c = ref1[l];
          if (c === 'id_with_url') {
            r[c] = r['id'];
          }
          row.push(r[c]);
        }
        rows.push(row);
      }
      $form = $('.t_download_export', el);
      $('.filename', $form).val(fn);
      $('.data', $form).val(JSON.stringify(rows));
      $('.expopts', $form).val(JSON.stringify((function() {
        var len2, m, ref2, results;
        ref2 = data.cols;
        results = [];
        for (m = 0, len2 = ref2.length; m < len2; m++) {
          c = ref2[m];
          results.push({});
        }
        return results;
      })()));
      return $form.trigger('submit');
    };

    TableHolder.prototype.collect_view_model = function(el, data) {
      return this.outer = el;
    };

    TableHolder.prototype.element = function() {
      return this.outer;
    };

    TableHolder.prototype.draw_table = function() {
      var table;
      table = new Table(this);
      return table.render();
    };

    TableHolder.prototype.xxx_table = function() {
      return new Table(this);
    };

    TableHolder.prototype.table_ready = function(html) {
      var table;
      table = $('.search_table_proper', this.outer);
      table.empty();
      return table.append(html);
    };

    return TableHolder;

  })();

  Table = (function() {
    var _idx;

    _idx = 0;

    function Table(holder) {
      var ref;
      this.holder = holder;
      this.multisort = (ref = this.holder.options.multisort) != null ? ref : true;
    }

    Table.prototype.render_head = function(t_data, data, first) {
      var c, dir, j, len, ref, state;
      t_data.headings = {};
      ref = this.holder.state.coldata();
      for (j = 0, len = ref.length; j < len; j++) {
        c = ref[j];
        state = 'off';
        dir = this.holder.state.sortkey(c.key);
        if (dir != null) {
          state = (dir > 0 ? "asc" : "desc");
        }
        if (c.nosort) {
          state = '';
        }
        t_data.headings[c.key] = {
          text: c != null ? c.name : void 0,
          state: state,
          key: c.key,
          dir: dir
        };
      }
      return t_data.first = first;
    };

    Table.prototype.render_row = function(data) {
      var klass;
      this.stripe = !this.stripe;
      klass = '';
      if (this.stripe) {
        klass = ' stripe';
      }
      if ((this.holder.options.style_col != null) && (data[this.holder.options.style_col] != null)) {
        klass += ' ' + data[this.holder.options.style_col];
      }
      return {
        cols: data,
        stripe: this.stripe,
        klass: klass
      };
    };

    Table.prototype.render_data = function(data, first) {
      var c, j, len, r, ref, t_data, t_main, table, widths;
      t_data = {
        table_row: [],
        rows: [],
        cols: data.cols
      };
      widths = (function() {
        var j, len, ref, results;
        ref = this.holder.state.coldata();
        results = [];
        for (j = 0, len = ref.length; j < len; j++) {
          c = ref[j];
          results.push(c.percent);
        }
        return results;
      }).call(this);
      t_data.widths = widths;
      if (first) {
        this.render_head(t_data, data, first);
      }
      ref = data.rows;
      for (j = 0, len = ref.length; j < len; j++) {
        r = ref[j];
        t_data.rows.push(this.render_row(r));
      }
      t_main = this.holder.templates.generate('chunk', t_data);
      table = this;
      $('.search_table_sorter', t_main).on('click', function(e) {
        var dir, key, l, len1, order, ref1;
        order = [];
        key = $(this).data('key');
        dir = $(this).data('dir');
        if (e.shiftKey && table.multisort) {
          ref1 = this.holder.state.order();
          for (l = 0, len1 = ref1.length; l < len1; l++) {
            e = ref1[l];
            if (e.column !== key) {
              order.push(e);
            }
          }
        }
        order.push({
          column: key,
          order: (dir > 0 ? -1 : 1)
        });
        table.holder.state.order(order);
        table.holder.state.set();
        return false;
      });
      return t_main;
    };

    Table.prototype.render_chunk = function(data, first) {
      var d, outer;
      d = $.Deferred();
      outer = this.render_data(data, first);
      outer.appendTo(this.container);
      return d.resolve(data);
    };

    Table.prototype.reset = function() {
      if (this.container != null) {
        this.container.remove();
      }
      this.container = $('<div/>').addClass('search_table');
      this.stripe = 1;
      this.empty = 1;
      return this.holder.table_ready(this.container);
    };

    Table.prototype.draw_top = function() {};

    Table.prototype.draw_rows = function(rows) {
      var d;
      d = this.render_chunk(rows, this.empty);
      this.empty = 0;
      return d;
    };

    Table.prototype.draw_bottom = function() {};

    Table.prototype.render = function() {
      var chunk, page, start;
      if (this.container != null) {
        this.container.remove();
      }
      this.container = $('<div/>').addClass('search_table');
      this.stripe = 1;
      start = this.holder.state.start();
      page = this.holder.state.pagesize();
      chunk = this.holder.options.chunk_size;
      return this.get_page(page, start, chunk);
    };

    return Table;

  })();

  window.TableState = TableState;

  window.search_table = TableHolder;

}).call(this);
