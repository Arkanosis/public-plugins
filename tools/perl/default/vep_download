# Copyright [1999-2013] Wellcome Trust Sanger Institute and the EMBL-European Bioinformatics Institute
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
#      http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

## Convert and download VEP output files 

use CGI;

use EnsEMBL::Web::TmpFile::Text;

my $cgi    = new CGI;
my %params;
foreach my $p($cgi->param) {
  foreach my $v($cgi->param($p)) {
    $params{$p} = $v;
  }
}

my $file   = $params{'file'};
my $name   = $params{'name'} || $file;
my $format = $params{'format'} || 'vcf';
my $prefix = $params{'prefix'};
## Strip any invalid characters from params to prevent downloading of arbitrary files!
$prefix =~ s/\W//g;

## Match only our tmp file path structure (NNN/N/N/NNNNNNN.nnn) !
if ($file =~ m#^\w[\w/]*(?:\.\w{1,4})?$#) {
  ## Get content
  my $results_file = new EnsEMBL::Web::TmpFile::VcfTabix(filename => $file, prefix => $prefix);
  
  if ($results_file->exists) {
    my $data = $results_file->content(%params);
    
    if ($data) {
      $cgi->header(-type => 'text/plain', -attachment => $name);
      print $data;
    }
  }
}

1;
